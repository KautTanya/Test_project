{% extends 'courses/base.html' %}

{% block content %}
  <div class="container">
    <h2 class="mt-4 mb-3">Редагувати модуль</h2>
    
    <form method="post">
      {% csrf_token %}

      <div class="mb-3">
        <label for="id_title">Назва модуля:</label>
        {{ module_form.title }}
      </div>

      <hr>
      <h4>Уроки</h4>

      {{ lesson_formset.management_form }}

      <div id="formset-container">
        {% for lesson_form, content_formset in lesson_formsets %}
          <div class="lesson-form border p-3 mb-3 bg-light">
            <h5>Урок {{ forloop.counter }}</h5>
            {{ lesson_form.management_form }}
            {{ lesson_form.title.errors }}
            {{ lesson_form.title.label_tag }} {{ lesson_form.title }}

            <h6>Контент</h6>
            <div class="content-formset">
              {% for block_form in content_formset %}
                <div class="block-form border p-2 mb-2 bg-white">
                  {{ block_form.content_type.label_tag }} {{ block_form.content_type }}
                  {{ block_form.content.label_tag }} {{ block_form.content }}
                  {{ block_form.DELETE }} <label>Видалити</label>
                </div>
              {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-1" onclick="addContentBlock(this)">Додати блок</button>
          </div>
        {% endfor %}
      </div>

      <!-- Порожня форма (шаблон) для JS -->
      <div class="block-form empty-form-template border p-2 mb-2 bg-white" style="display: none;">
        {{ content_formset.empty_form.content_type.label_tag }} {{ content_formset.empty_form.content_type }}
        {{ content_formset.empty_form.content.label_tag }} {{ content_formset.empty_form.content }}
        {{ content_formset.empty_form.DELETE }} <label>Видалити</label>
      </div>


      <button type="button" class="btn btn-outline-success" onclick="addLessonForm()">Додати урок</button>
      <button type="submit" class="btn btn-primary mt-2">Зберегти</button>
      <a href="{% url 'admin_edit_course' module.course.id %}" class="btn btn-secondary">Назад</a>
    </form>
  </div>

  <script>
    function addLessonForm() {
      const container = document.getElementById('formset-container');
      const totalFormsInput = document.getElementById('id_{{ lesson_formset.prefix }}-TOTAL_FORMS');
      const currentFormCount = parseInt(totalFormsInput.value);
  
      const emptyFormHtml = document.getElementById('empty-form').innerHTML.replace(/__prefix__/g, currentFormCount);
  
      const div = document.createElement('div');
      div.classList.add('lesson-form', 'border', 'p-3', 'mb-3', 'bg-light');
      div.innerHTML = emptyFormHtml;
  
      container.appendChild(div);
      totalFormsInput.value = currentFormCount + 1;
    }
  </script>
  <script>
    function addContentBlock(button) {
      const lessonContainer = button.closest('.lesson-form');
      const contentContainer = lessonContainer.querySelector('.content-formset');
      const totalForms = contentContainer.querySelector('input[name$="-TOTAL_FORMS"]');
      const currentCount = parseInt(totalForms.value);
      const emptyForm = contentContainer.querySelector('.empty-form-template').cloneNode(true);
      emptyForm.style.display = 'block';
      emptyForm.classList.remove('empty-form-template');
      emptyForm.innerHTML = emptyForm.innerHTML.replace(/__prefix__/g, currentCount);
      contentContainer.insertBefore(emptyForm, button);
      totalForms.value = currentCount + 1;
    }
  </script>
    
  
  
  
{% endblock %}

